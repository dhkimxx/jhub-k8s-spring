# 2026-01-13 Kubernetes Events API 403 (RBAC 부족)

## 0) 문서 메타데이터

- 문서 ID: `2026-01-13-k8s-events-rbac-403`
- 작성자: dhkim / Cascade
- 작성일: 2026-01-13
- 상태: 해결
- 영향 범위: 개발(로컬) / Kubernetes `jhub` 네임스페이스
- 심각도: 보통 (이벤트 패널만 실패)
- 관련 컴포넌트:
  - `SessionApiController` / `SessionService`
  - `KubernetesEventRepository`
  - Kubernetes `events.k8s.io` API

---

## 1) 요약

- 이벤트 조회 REST API(`/api/sessions/{username}`) 호출 시 K8s Events API가 403 Forbidden으로 실패했다.
- 원인은 서비스어카운트 `system:serviceaccount:jhub:spring-boot-admin`에게 `events.k8s.io` 그룹의 `events` 리소스에 대한 `list` 권한이 없었기 때문이다.
- `Role + RoleBinding`을 추가하여 해결했다.

---

## 2) 증상

- `GET http://localhost:8080/api/sessions/test` 응답이 500으로 떨어짐.
- 메시지: `Failed to list events for pod jupyter-test (code=403, body={... "reason":"Forbidden" ... })`

---

## 3) 환경

- 로컬 Spring Boot 애플리케이션 (`./gradlew bootRun`)
- Kubernetes(k3s) API URL: `https://192.168.20.12:6443`
- 서비스어카운트: `jhub` 네임스페이스의 `spring-boot-admin`

---

## 4) 재현 절차

1. 애플리케이션 실행: `./gradlew bootRun`
2. Swagger 또는 브라우저에서 `GET /api/sessions/{username}` 호출
3. 이벤트 패널에서 500 에러 발생

---

## 5) 기대 동작

- 이벤트 권한이 있어 세션 상세 호출이 성공하고 이벤트 목록을 반환

## 6) 실제 동작

- 내부에서 Events API 호출이 403으로 실패하고 GlobalExceptionHandler에 의해 500으로 노출

---

## 7) 원인 분석

- `KubernetesEventRepository`는 `EventsV1Api.listNamespacedEvent`를 호출하며, `events.k8s.io` API 그룹에 대한 권한이 필요함
- 기존 RBAC에서는 Pod/Node 조회만 허용했고 Events 권한이 없었다

---

## 8) 해결 방법

### RBAC 설정 추가

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: jhub-events-reader
  namespace: jhub
rules:
  - apiGroups: ["events.k8s.io"]
    resources: ["events"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: jhub-events-reader-binding
  namespace: jhub
subjects:
  - kind: ServiceAccount
    name: spring-boot-admin
    namespace: jhub
roleRef:
  kind: Role
  name: jhub-events-reader
  apiGroup: rbac.authorization.k8s.io
```

- 적용 후 `/api/sessions/{username}`가 200 OK로 정상 동작

---

## 9) 검증

- `kubectl auth can-i --as system:serviceaccount:jhub:spring-boot-admin list events.events.k8s.io -n jhub`
  - 권한 부여 전: `no`
  - 권한 부여 후: `yes`
- REST 호출 확인: `curl http://localhost:8080/api/sessions/test` → 이벤트 포함 응답

---

## 10) 재발 방지

- 향후 새로운 API 리소스를 조회할 때 최소 권한을 문서화하고 동시에 적용
- 서비스어카운트 토큰이 바뀌거나 클러스터가 변경되면 `kubectl auth can-i ...` 체킹을 런북에 포함

---

## 11) 참고

- 이전 422 이슈 문서: `2026-01-13-k8s-api-list-422-sendinitialevents.md`
- OpenAPI UI: `http://localhost:8080/swagger-ui/index.html`
